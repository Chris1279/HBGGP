clear all
close all

%% System matrix
A=[210.222575735787,-3337.12275409174,1362654245.7685,0,0,0,0,-2.73467585147103e-05,-0.000102250163830329,0.00894282724117875,-0.000102250163830329,-173.357644163231,1252.3065077607,0,-9.98116763169234e-05,0,-507.046429454317,-0.000223169539602993;-3337.12275409174,-5867.84210727112,2396028120.68218,0,0,0,0,0.000434108895158762,0.00162314321919759,-0.141960549041558,0.00162314321919759,2751.92013469702,-2367.72176852098,0,0.00158443409323083,0,8048.97462224233,0.00354264591241468;1487053.46414027,2614765.94528827,-433192164157.629,-1567441.77270774,0,0,0,-0.193443029798135,-0.723287971335229,63.2589634183279,-0.723287971335229,-1226281.64166747,1055079.21567534,0,-0.706038818664676,0,-3586699.22468148,-1.57863652747585;0,0,1423893989.1495,1331.72696757127,1715.47901873458,-4758.68156006788,-1.4238939891495,0,0,0,0,0,0,-2198.97976312588,0,0,0,0;0,0,0,-2679.49121671652,-1715.47901873458,4758.68156006788,1.4238939891495,0,0,0,0,0,0,0,0,0,0,0;0,0,0,4800.20178894007,3073.21233346296,1407.81103547709,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,1567441.77270774,1003516.4352818,0,0,0,0,0,0,0,0,0,0,0,0,0;-29.8432945176442,473.739496548489,-193443029.798217,0,0,0,0,634.783881222049,1.05908369603583,-92.627749167179,1.05908369603583,1795598.63416575,-177.778013644612,0,2316.86849649207,0,11769764240.1214,2.31153879848138;-111.58476980094,1771.3229562079,-723287971.335876,0,0,0,0,1.05908369603583,2376.3724973911,-124741995.177248,2376.3724973911,6713784.90500801,-664.71611291019,0,3.86550087845642,0,19636865.0522457,5186.6318478174;-0.000111584769800941,0.0017713229562079,-723.287971335885,0,0,0,0,1.05908369603583e-06,1.42627036164689,-124.741995177248,0.0023763724973911,6.71378490500801,-0.00066471611291019,0,3.86550087845642e-06,0,19.6368650522457,3.11295442504779;-111.58476980094,1771.3229562079,-723287971.335876,0,0,0,0,1.05908369603583,2376.3724973911,-207838.18733121,2376.3724973911,6713784.90500801,-664.71611291019,0,3.86550087845642,0,19636865.0522457,5186.6318478174;0.0669718605228833,-1.0631271111424,434108.895158782,0,0,0,0,-0.000635649521888287,-0.0023767082931158,0.207867556116958,-0.0023767082931158,-4029.53438042845,0.398954757724457,0,-0.00232002795855104,0,-11785.8144059448,-0.0051873647500884;1339.0794976231,-2531.78248029053,1033807983.80884,0,0,0,0,-0.000174193868214815,-0.000651314910087876,0.0569641798342221,-0.000651314910087876,-1104.25660157071,215.255448884387,0,-0.000635782189004725,0,-3229.79335425545,-0.00142154929807073;0,0,0,1347.76424914525,0,0,0,0,0,0,0,0,0,2198.97976312588,0,0,0,0;0.0669718605228833,-1.0631271111424,434108.895158782,0,0,0,0,-1.42452963867138,-0.0023767082931158,0.207867556116958,-0.0023767082931158,-4029.53438042845,0.398954757724457,0,7.58391703151126,-1426115726.52659,-11785.8144059448,-0.0051873647500884;0,0,0,0,0,0,0,0,0,0,0,0,0,0,2315.83467008924,0,0,0;0.0669718605228833,-1.0631271111424,434108.895158782,0,0,0,0,-1.42452963867138,-0.0023767082931158,0.207867556116958,-0.0023767082931158,-4029.53438042845,0.398954757724457,0,-0.00232002795855104,0,-11785.8144059448,-0.0051873647500884;-0.000111584769800941,0.0017713229562079,-723.287971335885,0,0,0,0,1.05908369603583e-06,0.0023763724973911,-124.741995177248,0.0023763724973911,6.71378490500801,-0.00066471611291019,0,3.86550087845642e-06,0,19.6368650522457,3.11295442504779];
B=[4.30996554313945e-08;-6.8417409657736e-07;0.000304874448847192;0;0;0;0;-0.00044641632504395;-0.00166916098475521;-1.66916098475521e-09;-0.00166916098475521;1.0018107028606e-06;2.74536950852465e-07;0;1.0018107028606e-06;0;1.0018107028606e-06;-1.66916098475521e-09];
C=[0.00735562358726779,0.00238975724876011,-1.43122560258322e+15,0,0,0,0,0.28372337709818,2376.3724973911,-124534156.989792,2376.3724973911,-31.186513070845,0.00662323988834571,0,-1.79558170803806e-05,0,-91.2161109250713,3107767.79319685];
D=[7.75349696258267e-09];

A=[-292.714369057608,-3695.92414000104,0,-30565581695.3905,0,0,0,0,0,7.46845275381469,707.388045311598,-2.51871261974836e-05,0.154462350466209,159366.512554163,0,0,0,0,0,0,0.000117322619205895,707.388045311598,-0.00185112721000278,-0.245980614281704,6.00879697945566e-05,272.756943422533,1252.64176358828,0,0,8.48002952996122e-06,0,0,0.00243666190825224,7.22247213953298,-0.694443864469733,-0.628992253671155;-3695.92414000104,-6123.81595813289,0,-50644436916.3363,0,0,0,0,0,94.2995552613349,8931.753372343,-0.000318022337035742,1.95030101068122,2012222.84631957,0,0,0,0,0,0,0.00148136048765992,8931.753372343,-0.0233730437071215,-3.10584578818241,0.000758693803803069,3443.934012443,-2051.67899805559,0,0,0.00010707211246934,0,0,0.0307662298805344,91.1937094731525,-8.76831516958792,-7.94189797274601;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1312466.4968603,0,0,0,0,0,0,0,0,0;1646938.75550408,2728830.31441781,0,9716898767707.67,-1567441.77270774,0,0,0,0,-42020.7737776714,-3980073.78568273,0.141713761468211,-869.072577715204,-896665533.377823,0,0,0,0,0,0,-0.66010824507883,-3980073.78568273,10.4152493550247,1383.99426054408,-0.338081135248702,-1534649.57115691,914247.567795204,0,0,-0.0477123460815031,0,0,-13.7097230439929,-40636.7795171273,3907.2441766227,3538.98485685954;0,0,0,-28838574007.6543,1331.72696757127,1715.47901873458,-4758.68156006788,0,-1.57284151147642,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-2198.97976312588,0,0,0,0,0,0,0,0;0,0,0,0,-2679.49121671652,-1715.47901873458,4758.68156006788,0,1.57284151147642,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,4800.20178894007,3073.21233346296,1216.06020608906,1.31287421391608,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,-1553883.89659999,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,1567441.77270774,1003516.4352818,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;-0.093188156142193,-1.17662947996596,0,-9730817.82329959,0,0,0,0,0,-124.670466052104,-11808.3892602305,0.000420447295467137,-2.57843141752288,-2660296.32225853,0,0,0,0,0,0,-0.00195845995112495,-11808.3892602305,0.0309007634654876,4.10614070051114,-0.00100304513472101,-4553.11647222592,0.39878936120959,0,0,-2.50335837547087,0,0,-0.0406750615870171,-120.564325351593,11.5923127702663,10.4997326748626;-0.093188156142193,-1.17662947996596,0,-9730817.82329959,0,0,0,0,0,-124.670466052104,5952806.60708421,0.000420447295467137,-2.57843141752288,-2660296.32225853,0,0,0,0,0,0,-0.00195845995112495,-11808.3892602305,0.0309007634654876,4.10614070051114,-0.00100304513472101,-4553.11647222592,0.39878936120959,0,0,-2.50335837547087,0,0,-0.0406750615870171,-120.564325351593,11.5923127702663,10.4997326748626;-36.2615046443745,-457.851696174272,0,-3786469335.86243,0,0,0,0,0,-48511.9447683171,-4594896.81666607,-419.82399233012,2574608.9541404,2656352496097.83,0,0,0,0,0,0,-0.762078654138695,-4594896.81666607,12.0241479638674,1597.78716789976,-0.390306314851837,-1771715.000504,155.177469675342,0,0,-974.110285232108,0,0,-15.8275364137187,-46914.1576004173,4510.81683301551,4085.6705500058;-0.153126299938021,-1.93343152312875,0,-15989629.9096248,0,0,0,0,0,-204.857870020086,-19403.4846329031,-1.77284685787831,4253.09940732737,11217334554.8608,0,0,0,0,0,0,-0.00321813134105896,-19403.4846329031,0.0507759759467185,6.74718932676435,-0.0016481986178416,-7481.65762100979,0.655288631791948,0,0,-4.11350563557773,0,0,-0.0668370524592502,-198.110680693321,19.0484288534604,17.2531068477096;-36.2615046443745,-457.851696174272,0,-3786469335.86243,0,0,0,0,0,-48511.9447683171,-4594896.81666607,-419.82399233012,2574608.9541404,-386803496541.14,-634.500629782664,0,0,4101651.23154692,0,0,-0.762078654138695,-4594896.81666607,12.0241479638674,1597.78716789976,-0.390306314851837,-1771715.000504,155.177469675342,0,0,-974.110285232108,0,0,-15.8275364137187,-46914.1576004173,4510.81683301551,4085.6705500058;0,0,0,0,0,0,0,0,0,0,0,0,0,3043155992638.97,634.500629782664,0,0,-4101651.23154692,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-4101651.23154692,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,337233875.903664,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,-6829199724.27314,-1.4238939891495,-1.07932282966052,0,12561.0749452387,0,0,0,0,0,0,0,0,0,0,1032759.67413291,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,337233875.903664,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,12718170.6806918,0,0,0,0,0,0,0,0,0,0,0,4.22283358858496,0,0,0,0;128.033217417235,1616.59661770887,0,13369380462.1957,0,0,0,0,0,171287.441951706,16223800.6643012,-0.577661606606135,3542.56253097086,3655038489.08542,0,0,0,0,0,0,1959.00942974515,11811702300.897,-30909.4331903183,-4107292.74680836,1003.32655577135,6255624.9136809,-547.905303655997,0,0,0.194487749154875,0,0,40686.4736542893,120598151.68506,-11595565.1870561,-10502678.5500747;-0.093188156142193,-1.17662947996596,0,-9730817.82329959,0,0,0,0,0,-124.670466052104,-11808.3892602305,0.000420447295467137,-2.57843141752288,-2660296.32225853,0,0,0,0,0,0,-1.42585244910062,5952806.60708421,0.0309007634654876,4.10614070051114,-0.00100304513472101,-4553.11647222592,0.39878936120959,0,0,-0.000141556660851872,0,0,-0.0406750615870171,-120.564325351593,11.5923127702663,10.4997326748626;86.507693599969,1092.27939202502,0,9033235999.02975,0,0,0,0,0,115733.103055535,10961870.7176643,-0.39030631485187,2393.5891026566,2469585284.88351,0,0,0,0,0,0,1323.63609168374,10961870.7176643,-30895.6635178363,-4105463.01167337,1002.87958937179,4226713.14699143,-370.200992262891,0,0,0.131408762134042,0,0,40668.348462112,111921.322929084,-11590399.5428372,-10497999.7698807;-0.093188156142193,-1.17662947996596,0,-9730817.82329959,0,0,0,0,0,-124.670466052104,-11808.3892602305,0.000420447295467137,-2.57843141752288,-2660296.32225853,0,0,0,0,0,0,-1.42585244910062,-11808.3892602305,33.2815475267512,4.10614070051114,-0.00100304513472101,-4553.11647222592,0.39878936120959,0,0,-0.000141556660851872,0,0,-0.0406750615870171,-120.564325351593,11.5923127702663,10.4997326748626;86.507693599969,1092.27939202502,0,9033235999.02975,0,0,0,0,0,115733.103055535,10961870.7176643,-0.39030631485187,2393.5891026566,2469585284.88351,0,0,0,0,0,0,1323.63609168374,10961870.7176643,-30895.6635178363,-3811.78012645091,1002.87958937179,4226713.14699143,-370.200992262891,0,0,0.131408762134042,0,0,40668.348462112,111921.322929084,-11590399.5428372,-11305146851.2188;-0.093188156142193,-1.17662947996596,0,-9730817.82329959,0,0,0,0,0,-124.670466052104,-11808.3892602305,0.000420447295467137,-2.57843141752288,-2660296.32225853,0,0,0,0,0,0,-0.00195845995112495,-11808.3892602305,0.0309007634654876,4.10614070051114,-0.00100304513472101,-4553.11647222592,0.39878936120959,0,0,-0.000141556660851872,0,0,-0.0406750615870171,-120.564325351593,11.5923127702663,10.4997326748626;1483.05489649053,-2429.06844761182,1.4672902788321,-20088586038.769,0,0,0,0,0,-37.839363544547,-3584.02393319555,0.000127612084628879,-0.782592757307867,-807439.988493123,0,0,0,0,0,0,-0.000594422082670932,-3584.02393319555,0.00937884696836884,1.24627552660921,-0.000304439300712495,-1381.9394032041,927.623901070274,0,0,-4.2964577912492e-05,0,0,-0.0123454936147349,-36.5930880179378,3.51844146514816,3.18682695578778;0,0,0,0,1347.76424914525,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2198.97976312588,0,0,0,0,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-5.41592578381476,-12561.0749452387,-23.3675043268303,0,0,0,0,0,0,0,0,0,463310.263786588,0,0,-4.22283358858496,0,0,0,0;5.26401917289162,66.4655295095742,0,549675127.304952,0,0,0,0,0,124541199.384045,11796145533.3627,-420.011347621874,2575757.92756871,2657537949302.04,0,0,0,0,0,0,0.110629624611151,667033.129970802,-1.74552451809041,-231.947967093777,0.0566600847051009,257196.766185466,-22.5268417177635,0,0,141.409885449087,0,0,2.29765576356303,6810.44616075958,-654.827385881023,-593.109643967266;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,4.22283358858496,0,0,0,0;0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-11795478500.2327,0,0,0,0,0,0,0,0,337233875.903664,0,-123530640.554635,1881.73458968316,0,0,0,0;86.507693599969,1092.27939202502,0,9033235999.02975,0,0,0,0,0,115733.103055535,10961870.7176643,-0.39030631485187,2393.5891026566,2469585284.88351,0,0,0,0,0,0,1323.63609168374,10961870.7176643,-30895.6635178363,-3811.78012645091,1002.87958937179,4226713.14699143,-370.200992262891,0,0,0.131408762134042,0,0,40668.348462112,111921.322929084,-11590399.5428372,-10497999.7698807;-0.093188156142193,-1.17662947996596,0,-9730817.82329959,0,0,0,0,0,-124.670466052104,-11808.3892602305,0.000420447295467137,-2.57843141752288,-2660296.32225853,0,0,0,0,0,0,-1.42585244910062,-11808.3892602305,0.0309007634654876,4.10614070051114,-0.00100304513472101,-4553.11647222592,0.39878936120959,0,0,-0.000141556660851872,0,0,-0.0406750615870171,-120.564325351593,11.5923127702663,10.4997326748626;8.65348668135288e-05,0.00109262249146452,0,9036.07345822876,0,0,0,0,0,0.115769456357703,10.9653139865995,-3.90428915240411e-07,0.00239434096073019,2470.36101436556,0,0,0,0,0,0,0.00132405186333014,10.9653139865995,-0.0309053682553908,-0.00381297745712876,0.00100319460714793,4.2280408136326,-0.000370317277303031,0,0,1.31450039368568e-07,0,0,0.0406811229295829,0.111956478900574,-12485.457267737,-11308.697947739;8.65348668135288e-05,0.00109262249146452,0,9036.07345822876,0,0,0,0,0,0.115769456357703,10.9653139865995,-3.90428915240411e-07,0.00239434096073019,2470.36101436556,0,0,0,0,0,0,0.00132405186333014,10.9653139865995,-0.0309053682553908,-0.00381297745712876,1.08032602426767,4.2280408136326,-0.000370317277303031,0,0,1.31450039368568e-07,0,0,0.0406811229295829,0.111956478900574,-12485.457267737,-11308.697947739];
B=[-5.99711190434234e-08;-7.57218401285439e-07;0;0.000337423681930682;0;0;0;0;0;1.00109455161124e-06;1.00109455161124e-06;0.000389547301245592;1.64499342968751e-06;0.000389547301245592;0;0;0;0;0;0;-0.00137542539405935;1.00109455161124e-06;-0.000929328192785741;1.00109455161124e-06;-0.000929328192785741;1.00109455161124e-06;3.03847269368922e-07;0;0;-5.65499000280184e-05;0;0;-0.000929328192785741;1.00109455161124e-06;-9.29620107092996e-10;-9.29620107092996e-10];
C=[0.00845046074490121,0.0026453987945599,0,2.89506119279031e+16,0,0,0,0,0,-1.0935490165909,-103.577478066463,0.836588458123449,-0.0109085086135464,-5293346448.85045,0,0,0,0,0,0,1324.55745300056,-103.577478066463,-30924.3267286038,0.0360170798042191,1003.81000308594,-39.9377350409964,0.00662175689068699,0,0,2.43878216186437,0,0,40706.0782050859,-1.05753193678668,-12469946252.0151,-11294648851.4263];
D=[8.78111710893454e-09];

%% Matlab part of evolution
sys = ss(A,B,C,D);

%Determine the cutoff frequency
cutoff = 2*pi*1000;

%Create evaluation point array
a1 = 2;
b1 = 5;
a2 = 3;
b2 = 4;
n1 = 200;
n2 = 200;
w1 = logspace(a1,b1,n1);
%w2 = logspace(a2,b2,n2);
%w = sort([w1,w2]);
%n = n1+n2;
w = w1;
n = n1;
 
% Compute the frequency response
[mag,phase] = bode(sys,w);
mag = shiftdim(mag,1);
 
% Compute ideal response
idx = find(w > cutoff);
imag = zeros(size(w));
imag(idx) = 1;
 
% Compute the error in magnitude with the ideal response
error = imag - mag;
 
error2 = abs(error);
rmserror = sum(error2);
 
obj = n/(n+rmserror)

%% Plot

figure
subplot(3,1,1)
loglog(w,mag);
hold on
loglog(w,imag,'r');

subplot(3,1,2)
semilogx(w,mag);
hold on
semilogx(w,imag,'r');

subplot(3,1,3)
semilogx(w,error2)
ylabel('Error');